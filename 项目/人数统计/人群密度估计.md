

***项目介绍：*** 物联网设备感知仓，主要功能为在边缘设备rv1126和rk1808上实时进行无感人脸识别考勤和人数统计，并将结果上报到考勤系统。

***责任描述：***负责人数统计算法的研发、优化和模型部署。设计模型网络结构和训练方法，解决边缘设备部署问题、推断速度和精度要求；对图像进行合理扩增，增加模型鲁棒性；设计后处理方案，处理模型背景误检问题。该模型替换公司原有模型，在rk1808上每张图像的预测时间为200ms，相对原有模型速度上提升10倍，错误检测人数减少63%。目前已应用于全国上千个职场。



时间  2020.5 - 2021.8

框架：tensorflow

语言：python

方法：

迭代了两个版本。

采用150个场景数据，外加一些公有人脸检测数据。其中120个场景数据用于训练，30个场景数据用于验证

小大小的卷积 作为一个小的卷积模块，具体为一个depthwise 和两个pointwise卷积，通道分别为小，大，小， depthwise的

采用模型分patch 对图像进行下采样。具体为卷积核大小为4 ，步长为4， 通道为4C* n的下采样块

采用（2， 6， 2，2，2 ，2） 作为模型各个尺度的模型块数。在下采样八倍的尺度上模型深度最深，这是由于人头在这个尺度上最密集，这样做可以减少算力和增加该尺度人头的检出率。 下采样128倍可以减少百分之20的背景误检。

采用 （h, w, 4c）->  （h, w, 2, 2 ,c）-> （h, 2, w, 2, c） -> (2h,  2w,  c) 实现上采样，减少耗时。

现实场景中，采集的图像各式各样，训练的数据集无法全部涵盖，因此需要采用多种方式模拟现实图像， 包括局部噪声、饱和度扩增、色温变换、gamma变换、自适应缩放扩大、图像拉伸、小尺度旋转、随机擦除等等。

难样本挖掘方法，提高检测弱的样本精度。

多尺度训练。最后几个分辨率引出输出头，并使用不同大小的系数作为loss系数，优化整体损失，可以提高没有预训练的小模型精度。

后处理采用背景mask方式，去除背景固定物体误检。



在推断

难点：

由于瑞星微的边缘设备提供的toolkit工具包，支持的算子与连接方式有限，需要对模型的设计限制在可用算子中，并需要逐层量化部署测试，使得边端设备能够支持该模型。

在rk上可能出现在float转换时正常，在模型int8量化数据溢出，使得模型预测全空问题。模型在PC端训练过程中，由于训练过程导致模型预测数值不断变大，而在pc端中，float32的数据类型可以保证其正常预测，而当量化后，数值溢出导致模型预测错误。在模型特定位置加上bn，以及权重缩减，来控制预测数值。实现成功量化，以及减少量化误差。（瑞星微采用的默认量化方式为非对称量化-对称量化对于正负数不均匀分布的情况不够友好，比如如果浮点数全部是正数，非对称量化将浮点数值较为均匀的映射0-255之间）（瑞星微采用的是全量化，权重和图像都进行量化）（数值溢出的原因为模型学习的数值越界）。

在边缘设备业务上，需要模型在200ms内检测完，而rk1808 rv1126的算力只有2TOPs。（v100 算力约121TOPS），因此需要保证精度的情况下模型尽可能小，因此，采用depthwise pointiwise 两个算子组成的卷积核小大小的mlp卷积块，减小模型大小，提高模型精度。设计了下采样7次的模型结构，相对于5次下采样，在少量增加耗时的情况下，在无人场景的误检减少20%；设计了多级模型训练，在不同尺度上引出头部并计算loss，该方法能有效保证模型收敛，无需预训练权重，并比无该方法的准确率高3%。

生产测试中，场景多样，时间段横跨24小时 四季，而数据有限，因此需要设计好的扩增增加模型在新场景，不同时间段的鲁棒性。检测的场景包括不同光线、不同焦距、不同室内物体与相机噪声等干扰，及其容易误检和漏检。在数据处理上采用多样的数据扩增技术，包括色温变换、gamma变换、随机噪声、图像拉伸、图像缩小放大、图像旋转等增强算法提高模型鲁棒性；

Bad case 后处理。在实际业务中，对无人场景是的人头检出敏感，为了解决这种情况，设计了两种后处理算法：第一种：通常人在一定时间内会有一定的相对位移，因此连续n次在同一位置检出人头时对该目标进行过滤。第二种是：在有误检的场景下，在无人时手动设置掩码，模型输出后先对掩码进行过滤，在进行后处理输出预测，两种方法有效过95%滤墙上人头以及误检人头。









# 参考文献 #